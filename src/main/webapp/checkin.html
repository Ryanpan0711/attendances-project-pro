<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­å“¡å·¥æ‰“å¡ç³»çµ±</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f6f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 350px;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .time-display {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            font-family: monospace;
        }

        input,
        button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            box-sizing: border-box;
        }

        input {
            border: 1px solid #ddd;
            font-size: 16px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        #memo-container {
            display: none;
            text-align: left;
        }

        #status-msg {
            margin-top: 15px;
            font-size: 14px;
            min-height: 20px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .btn-export {
            background-color: #27ae60;
            margin-top: 5px;
        }

        .btn-export:hover {
            background-color: #219150;
        }
    </style>
</head>

<body>

    <div class="card">
        <h1>ğŸ•’ ä¸Šç­æ‰“å¡</h1>
        <div class="time-display" id="clock">00:00:00</div>

        <input type="text" id="userId" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ (ä¾‹: A001)" />

        <div id="memo-container">
            <label for="memo" style="font-size: 12px; color: #e74c3c;">* æ‚¨å·²é²åˆ°ï¼Œè«‹è¼¸å…¥åŸå› ï¼š</label>
            <input type="text" id="memo" placeholder="ä¾‹å¦‚: å…¬è»Šèª¤é»" />
        </div>

        <button id="btn-checkin" onclick="doCheckIn()">ä¸Šç­æ‰“å¡ (IN)</button>
        <button class="btn-export" onclick="window.open('/attendances-project/api/export')">ğŸ“¥ åŒ¯å‡ºå ±è¡¨ (CSV)</button>

        <div id="status-msg"></div>
    </div>

    <script>
        // 1. å³æ™‚æ™‚é˜
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-TW', { hour12: false });

            // ç°¡å–®çš„å‰ç«¯ UX: è¶…é 09:00 è‡ªå‹•é¡¯ç¤ºå‚™è¨»æ¬„ (å¯¦éš›ä¸Šå¾Œç«¯ä¹Ÿæœƒæ“‹)
            const hour = now.getHours();
            const min = now.getMinutes();
            if (hour >= 9 && !(hour === 9 && min === 0)) {
                document.getElementById('memo-container').style.display = 'block';
            } else {
                document.getElementById('memo-container').style.display = 'none';
            }
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. ç›£è½ User ID è¼¸å…¥ï¼Œæª¢æŸ¥ä»Šæ—¥ç‹€æ…‹
        document.getElementById('userId').addEventListener('change', async function () {
            const userId = this.value;
            if (!userId) return;

            try {
                // å‘¼å« StatusController
                const resp = await fetch(`/attendances-project/api/status?userId=${userId}`);
                if (resp.ok) {
                    const status = await resp.json();
                    updateButtonState(status);
                }
            } catch (e) {
                console.error("ç‹€æ…‹æª¢æŸ¥å¤±æ•—", e);
            }
        });

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å‡½å¼
        function updateButtonState(status) {
            const btn = document.getElementById('btn-checkin');
            const msgDiv = document.getElementById('status-msg');

            // é‡ç½®ç‹€æ…‹
            btn.disabled = false;
            btn.innerText = "ä¸Šç­æ‰“å¡ (IN)";
            btn.dataset.type = "IN"; // ä½¿ç”¨ dataset å„²å­˜ç•¶å‰è¦åŸ·è¡Œçš„é¡å‹

            if (status.hasCheckedIn) {
                if (status.hasCheckedOut) {
                    // ä»Šæ—¥æµç¨‹å·²çµæŸ
                    btn.innerText = "ä»Šæ—¥å·²å®Œæˆæ‰“å¡";
                    btn.disabled = true;
                    btn.dataset.type = "DONE";
                } else {
                    // å·²ä¸Šç­ï¼Œè®Šæ›´ç‚ºä¸‹ç­æ¨¡å¼
                    btn.innerText = "ä¸‹ç­æ‰“å¡ (OUT)";
                    btn.dataset.type = "OUT";
                }
            }
        }

        // 3. æ‰“å¡å‡½å¼
        async function doCheckIn() {
            const userId = document.getElementById('userId').value;
            const memo = document.getElementById('memo').value;
            const msgDiv = document.getElementById('status-msg');
            const btn = document.getElementById('btn-checkin');

            // å¾æŒ‰éˆ• dataset å–å¾—é¡å‹ (é è¨­ IN)
            const type = btn.dataset.type || "IN";

            if (!userId) {
                msgDiv.innerText = "è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ";
                msgDiv.className = "error";
                return;
            }

            msgDiv.innerText = "æ‰“å¡ä¸­...";
            msgDiv.className = "";

            try {
                const response = await fetch('/attendances-project/api/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, memo: memo, checkInType: type })
                });

                const result = await response.json();

                if (response.ok) {
                    msgDiv.innerHTML = `âœ… ${type} æ‰“å¡æˆåŠŸ!<br>ç‹€æ…‹: ${result.data.status}<br>æ™‚é–“: ${result.data.checkInTime}`;
                    msgDiv.className = "success";
                    // æ‰“å¡æˆåŠŸå¾Œå†æ¬¡æª¢æŸ¥ç‹€æ…‹ï¼Œæ›´æ–°æŒ‰éˆ•
                    document.getElementById('userId').dispatchEvent(new Event('change'));
                } else {
                    msgDiv.innerText = `âŒ å¤±æ•—: ${result.message}`;
                    msgDiv.className = "error";
                }
            } catch (err) {
                msgDiv.innerText = "âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
                msgDiv.className = "error";
                console.error(err);
            }
        }
    </script>
</body>

</html>